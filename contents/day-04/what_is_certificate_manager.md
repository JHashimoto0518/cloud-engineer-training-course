[toc]

# AWS Certificate Managerとは

Certificate Managerは、SSL/TLS証明書の購入、デプロイ、管理を容易にするサービス。証明書を取得して、CloudFront、ELB、API GatewayなどのAWSリソースにデプロイできる。

証明書の購入、アップロード、更新という手間のかかる作業を自動化できる。[^1]

[^1]: 自社サーバーで大量のECサイトを管理した経験のあるソリューションアーキテクトが、一番好きなAWSサービスに挙げていた。

# SSL/TLS証明書とは

SSL/TLS[^2]は２つのシステム間の通信を保護する。 

[^2]: TLSはSSL後継のプロトコルである。SSLは脆弱性が発見されたので使用すべきではないが、広く認知されているので、今でも名称としては使われることがある。

２つのシステムは、サーバーとクライアント、またはサーバーとサーバーである場合もあるが、ここでは、最も一般的なECサイトでのオンラインショッピングを例として説明する。

ブラウザからクレジットカード番号を登録する行為を取り上げる。この場合、利用者は以下の懸念がある。

1. クレジットカード番号が盗聴されないだろうか？
2. 入力したクレジットカード番号が改ざんされないだろうか？
3. 通信相手のECサイトは本物だろうか？

## 1. クレジットカード番号が盗聴されないだろうか？

これは**機密性**の問題であり、暗号化によるネットワーク通信の保護で解決する。そのために使われるのが、**共通鍵暗号**である。

共通鍵暗号の鍵を通信相手に配送するためには、公開鍵暗号を使う。

[^3]: Diffie-Hellman鍵交換を使うこともあるが、今回はわかりやすい公開鍵暗号を使用したケースについて説明する。

## 2. 入力したクレジットカード番号が改ざんされないだろうか？

これは**正真性****の問題であり、改ざんの検出とデータの認証で解決する。

そのために使われるのが**メッセージ認証コード**である。メッセージ認証コードは**ハッシュ関数**を使って生成する。

## 3. 通信相手のECサイトは本物だろうか？

これは**認証**の問題であり、サーバー認証により、サーバー所有者の企業がなりすましではないことを証明して、解決する。

そのために、公開鍵に**デジタル署名**をつけた**デジタル証明書**を使う。

## SSL/TLSの役割

SSL/TLSはフレームワークであり、1.2.3.で挙げた暗号技術を組み合わせて、セキュアな通信を提供する。

冒頭のシナリオで、ECサイトとのセキュアな取引を提供するために登場するのが、SSL/TLS証明書である。

以降で、SSL/TLS証明書の構成要素としての暗号技術について説明していく。

# 共通鍵暗号方式と公開鍵暗号方式

## 共通鍵暗号方式とは

送信者と受信者が同じ鍵[^4]を用いる暗号化方式を**共通鍵暗号方式**と呼ぶ。

[^4]: 暗号化アルゴリズムで可変部分を鍵と呼ぶ。具体的には、暗号化/復号の関数に渡すパラメータのことを指す。

例として、パスワード付きZIPが挙げられる。

第3者には秘密にしておく必要があることから、**秘密鍵暗号方式**とも呼ばれる。

### 共通鍵暗号方式のメリット

- 暗号化/復号に要する時間が短い
### 共通鍵暗号方式のデメリット
- 鍵の使いまわしができない。受け渡しのたびに異なる鍵を作成する必要がある。
- 鍵を受信者に伝える必要があるが、安全に受け渡しすることが難しい。鍵を送らなければ受信者は復号できないが、鍵を送ると盗聴者は復号できてしまう。これを**鍵配送問題**を呼ぶ。

## 公開鍵暗号方式とは

公開鍵暗号方式は、共通鍵暗号方式の鍵配送問題を解決する暗号方式である。暗号技術における画期的な発明といわれている。

### 公開鍵暗号方式の考え方

暗号化に使う鍵と復号に使う鍵を分けて考えると、以下のことがわかる。

- 暗号化に使う鍵は、盗聴の心配なく送ることができる。盗聴されも、メッセージの復号はできないからである。
- 盗聴されると困るのは、復号に使う鍵だけである。
- 復号に使う鍵を最初から受信者の手元に置いておけば、配送の必要がなくなり、鍵配送問題は解決する。

これが、公開鍵暗号方式の考え方である。公開鍵暗号方式では、暗号化に使う鍵を**公開鍵****、復号に使う鍵を**秘密鍵**と呼ぶ。

[JPRS用語辞典｜公開鍵暗号](https://jprs.jp/glossary/index.php?ID=0226)[^5]

[^5]: 画像では、公開鍵と秘密鍵が鍵のアイコンで表現されているが、南京錠をイメージした方が理解しやすい。公開鍵が錠前、秘密鍵が錠前を開ける鍵にあたる。

### 公開鍵暗号方式のメリット

- 鍵配送問題の解決。暗号化に使う鍵を公開できるので、受信者に渡すことが容易。復号に使う鍵は、最初から受信者が持っているので、そもそも配送の必要がない。
- 鍵を使いまわすことができる。鍵のペアを１セット用意すれば複数人とやり取りできる。
### 公開鍵暗号方式のデメリット
- 共通鍵暗号方式に比べて、暗号化や復号の処理時間が何百倍も遅い。

## 共通鍵暗号方式と公開鍵暗号方式の使い分け

一般的には、利用形態に応じて、共通鍵暗号方式は公開鍵暗号方式を使い分ける。または後述するハイブリッド暗号方式を採用する。

SSL/TLS証明書において、共通鍵暗号方式と公開鍵暗号方式をどのように使い分けるかは後述する。

## 公開鍵暗号方式でも解決できない問題

公開鍵暗号方式では、通信相手のなりすましを防ぐことができない。受信者から公開鍵を受け取ったつもりが、実は受信者になりすました盗聴者だったということがあり得る。

なりすましを防ぐためには、受け取った公開鍵が間違いなく受信者のものであることを検証する手段、つまり認証が必要になる。

ここで必要になるのが、公開鍵の証明書（**デジタル証明書**）である。デジタル証明書とは公開鍵に信用できる第三者が**デジタル署名**をつけたものである。

# デジタル証明書とは

### デジタル証明書とは何か

デジタル証明書は、公開鍵証明書(public-key certificate) とか、単に**証明書** (certificate) とも呼ばれる。

公開鍵に認証局 (certificate authority, certifying authority: CA) によるデジタル署名が施されたものが**デジタル証明書**である。

デジタル証明書は、運転免許証に似ている。デジタル証明書には名前や所属、メールアドレスなどの個人情報、およびその人の公開鍵が記載されている。

# 認証局 (CA) とは

「間違いなくこの公開鍵はこの人のものである」と証明できる人や組織のことである。

- 暗号技術入門:  P.256

# デジタル署名とは
改ざんと、なりすましを防ぐ技術である。

公開鍵が印鑑だとすると、印鑑証明にあたる。

CAが公開鍵にデジタル署名をすることで、その公開鍵は確かに本人のものであると、CAが証明したことになる。

- 応用情報技術者: P609

----

# obsolete
## CA

>  公開鍵証明書 (public-key certificate)は、運転免許証とよく似ている。公開鍵証明書には名前や所属、メールアドレスなどの個人情報、その人の公開鍵が記載され、認証局 (certificate authority, certifying authority: CA) によるデジタル署名が行われている。公開鍵証明書を見れば、認証局が「この公開鍵は確かにこの人のものである」と認めたことがわかる。公開鍵証明書は、単に**証明書** (certificate) とも呼ぶ。

> 認証局はなかなかイメージしにくい存在であうが、要するに「確かにこの公開鍵はこの人のものである」と認め、デジタル署名を作成できる人や組織のことである。国際的な組織や政府が作ったものもありますし、認証局のサービスの提供を業務としている一般企業もある。また、個人で認証局を作ることも可能である。有名な認証局にベリサインがある。

### > 証明書を使うシナリオ

2. 受信者は、認証局に自分の公開鍵を登録する
    1. 受信者は自身の公開鍵を送信者ではなく、認証局に送る。それは、受信者の公開鍵に対して認証局にデジタル署名をしてもらうため（**すなわち証明書を作成してもらうため**）である。
    2. 受信者から公開鍵を受け取った認証局は、受け取った公開鍵が本当に受信者のものであるか確認する。（コラム「本人確認と運用規程」参照）

# デジタル署名とは

- 電子メールによる借用書
	- 改ざん
	- なりすまし
	- 否認
- メッセージ認証コードの限界
	- 改ざんとなりすましは検出できる
	- 否認防止はできない
- [【図解】よく分かるデジタル証明書(SSL証明書)の仕組み 〜https通信フロー,発行手順,CSR,自己署名(オレオレ)証明書,ルート証明書,中間証明書の必要性や扱いについて〜 | SEの道標](https://milestone-of-se.nesuke.com/sv-advanced/digicert/digital-certification-summary/)
> デジタル証明書を発行する中間認証局が、その中間認証局の秘密鍵でデジタル証明書にデジタル署名します。これにより、デジタル証明書に書かれたホスト名の機器は、中間認証局がお墨付きをくれた状態になります。(印鑑証明で言う地方役所)

- TODO: SSL証明書にデジタル署名の説明は必要か
	- [ディジタル署名とサーバ証明書と公開鍵の関係を調べよう！ \| ITの学び](https://itmanabi.com/digital-signature-server-certificate/)

## メッセージ認証コード
# デジタル証明書とは
- なりすましを防ぐ
## CAとは

# others
- クライアントはどうやってサーバー証明書の正当性を確認するのか (CLI)
- curlのオプション（TTLなど）
- ハイブリッド認証
- コインチェック事件

# 参考
- [電子署名と電子証明書の違いの説明を集めてみました。 \- Qiita](https://qiita.com/ponsuke0531/items/47e147896467e7ba5838#:~:text=%E3%83%87%E3%82%B8%E3%82%BF%E3%83%AB%E7%BD%B2%E5%90%8D%E3%81%AF%E3%80%81%E6%96%87%E6%9B%B8%E3%81%AB,%E3%82%92%E8%A1%8C%E3%81%A3%E3%81%9F%E3%82%82%E3%81%AE%E3%81%A7%E3%81%99%E3%80%82&text=%E3%83%87%E3%82%B8%E3%82%BF%E3%83%AB%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%81%AF%E3%80%81%E8%A8%BC%E6%98%8E,%E8%A8%BC%E6%98%8E%EF%BC%89%E3%81%8C%E3%81%A7%E3%81%8D%E3%82%8B%E4%BB%95%E7%B5%84%E3%81%BF%E3%81%A7%E3%81%99%E3%80%82)


# SSL通信おけるサーバー証明書の役割

[ディジタル署名とサーバ証明書と公開鍵の関係を調べよう！ | ITの学び](https://itmanabi.com/digital-signature-server-certificate/)

>SSL通信を確立する時、PC（クライアント）がWebサーバにアクセスするとサーバからサーバ証明書がPCに送られてきます。このサーバ証明書をもらったPCはサーバ証明書を使って、相手のサーバが正当なサーバであるかの検証を行います。

# サーバー証明書の構成要素

- 公開鍵
- デジタル署名

[【図解】よく分かるデジタル証明書(SSL証明書)の仕組み 〜https通信フロー,発行手順,CSR,自己署名(オレオレ)証明書,ルート証明書,中間証明書の必要性や扱いについて〜 | SEの道標](https://milestone-of-se.nesuke.com/sv-advanced/digicert/digital-certification-summary/)

>通信の暗号化をするための共通鍵の交換は Diffie-Hellman (DH) 系の方式が使われますが、DH 公開鍵を abc の秘密鍵で署名することで、『このサーバは間違いなく abc.example.com だ』と認識 (サーバを認証) することができます。

#