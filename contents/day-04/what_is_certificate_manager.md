# AWS Certificate Managerとは

Certificate Managerは、SSL/TLS証明書の購入、デプロイ、管理を容易にするサービス。証明書を取得して、CloudFront、ELB、API GatewayなどのAWSリソースにデプロイできる。

証明書の購入、アップロード、更新という手間のかかる作業を自動化できる。[^1]

[^1]: 自社サーバーで大量のECサイトを管理した経験のあるソリューションアーキテクトが、一番好きなAWSサービスに挙げていた。

# SSL/TLS証明書とは

SSL/TLS[^2]は２つのシステム間の通信を保護する。 

[^2]: TLSはSSL後継のプロトコルである。SSLは脆弱性が発見されたので使用すべきではないが、広く認知されているので、今でも名称としては使われることがある。

２つのシステムは、サーバーとクライアント、またはサーバーとサーバーである場合もあるが、ここでは、最も一般的なECサイトでのオンラインショッピングを例として説明する。

ブラウザからクレジットカード番号を登録する行為を取り上げる。この場合、利用者は以下の懸念がある。

1. クレジットカード番号が盗聴されないだろうか？
2. 入力したクレジットカード番号が改ざんされないだろうか？
3. 通信相手のECサイトは本物だろうか？

## 1. クレジットカード番号が盗聴されないだろうか？

これは**機密性**の問題であり、暗号化によるネットワーク通信の保護で解決する。そのために使われるのが、**共通鍵暗号**である。

共通鍵暗号の鍵を通信相手に配送するためには、公開鍵暗号を使う。

## 2. 入力したクレジットカード番号が改ざんされないだろうか？

これは**正真性****の問題であり、改ざんの検出とデータの認証で解決する。

そのために使われるのが**メッセージ認証コード**である。メッセージ認証コードは**ハッシュ関数**を使って生成する。

## 3. 通信相手のECサイトは本物だろうか？

これは**認証**の問題であり、サーバー認証により、サーバー所有者の企業がなりすましではないことを証明して、解決する。

そのために、公開鍵に**デジタル署名**をつけた**デジタル証明書**を使う。

## SSL/TLSの役割

SSL/TLSはフレームワークであり、1.2.3.で挙げた暗号技術を組み合わせて、セキュアな通信を提供する。

冒頭のシナリオで、ECサイトとのセキュアな取引を提供するために登場するのが、SSL/TLS証明書である。

以降で、SSL/TLS証明書の構成要素としての暗号技術について説明していく。

# 共通鍵暗号方式と公開鍵暗号方式

## 共通鍵暗号方式とは

送信者と受信者が同じ鍵[^4]を用いる暗号化方式を**共通鍵暗号方式**と呼ぶ。

[^4]: 暗号化アルゴリズムで可変部分を鍵と呼ぶ。具体的には、暗号化/復号の関数に渡すパラメータのことを指す。

例として、パスワード付きZIPが挙げられる。

第3者には秘密にしておく必要があることから、**秘密鍵暗号方式**とも呼ばれる。

### 共通鍵暗号方式のメリット

- 暗号化/復号に要する時間が短い

### 共通鍵暗号方式のデメリット
- 鍵の使いまわしができない。受け渡しのたびに異なる鍵を作成する必要がある。
- 鍵を受信者に伝える必要があるが、安全に受け渡しすることが難しい。鍵を送らなければ受信者は復号できないが、鍵を送ると盗聴者は復号できてしまう。これを**鍵配送問題**を呼ぶ。

## 公開鍵暗号方式とは

公開鍵暗号方式は、共通鍵暗号方式の鍵配送問題を解決する暗号方式である。暗号技術における画期的な発明といわれている。

### 公開鍵暗号方式の考え方

暗号化に使う鍵と復号に使う鍵を分けて考えると、以下のことがわかる。

- 暗号化に使う鍵は、盗聴の心配なく送ることができる。盗聴されも、メッセージの復号はできないからである。
- 盗聴されると困るのは、復号に使う鍵だけである。
- 復号に使う鍵を最初から受信者の手元に置いておけば、配送の必要がなくなり、鍵配送問題は解決する。

これが、公開鍵暗号方式の考え方である。公開鍵暗号方式では、暗号化に使う鍵を**公開鍵****、復号に使う鍵を**秘密鍵**と呼ぶ。

[JPRS用語辞典｜公開鍵暗号](https://jprs.jp/glossary/index.php?ID=0226)[^5]

[^5]: 画像では、公開鍵と秘密鍵が鍵のアイコンで表現されているが、南京錠をイメージした方が理解しやすい。公開鍵が錠前、秘密鍵が錠前を開ける鍵にあたる。

### 公開鍵暗号方式のメリット

- 鍵配送問題の解決。暗号化に使う鍵を公開できるので、受信者に渡すことが容易。復号に使う鍵は、最初から受信者が持っているので、そもそも配送の必要がない。
- 鍵を使いまわすことができる。鍵のペアを１セット用意すれば複数人とやり取りできる。
### 公開鍵暗号方式のデメリット
- 共通鍵暗号方式に比べて、暗号化や復号の処理時間が何百倍も遅い。

## SSL/TLSにおける共通鍵暗号方式と公開鍵暗号方式の使い分け

一般的には、利用形態に応じて、共通鍵暗号方式は公開鍵暗号方式を使い分ける。またはハイブリッド暗号方式を採用する。

### ハイブリッド暗号方式
ハイブリッド暗号方式は、共通鍵暗号でメッセージを暗号化し、暗号化に使った共通鍵を公開鍵暗号で暗号化する方式である。

つまり、共通鍵暗号と公開鍵暗号のいいとこどりである。

SSL/TLSでは、以前はハイブリッド暗号方式が採用されていたが、現在では、Diffie-Hellman鍵交換と呼ばれる鍵交換アルゴリズムが使われている。

## 公開鍵暗号方式でも解決できない問題

公開鍵暗号方式では、通信相手のなりすましを防ぐことができない。受信者から公開鍵を受け取ったつもりが、実は受信者になりすました盗聴者だったということがあり得る。

なりすましを防ぐためには、受け取った公開鍵が間違いなく受信者のものであることを検証する手段、つまり認証が必要になる。

ここで必要になるのが、公開鍵の証明書（**デジタル証明書**）である。デジタル証明書とは公開鍵に信用できる第三者が、公開鍵に**デジタル署名**をつけたものである。

# デジタル証明書とは

## デジタル証明書とは何か

デジタル証明書は、公開鍵証明書 (public-key certificate) とか、単に**証明書** (certificate) とも呼ばれる。

公開鍵に認証局 (certificate authority, certifying authority: CA) によるデジタル署名が施されたものが**デジタル証明書**である。

デジタル証明書は、運転免許証に似ている。デジタル証明書には名前や所属、メールアドレスなどの個人情報、およびその人の公開鍵が記載されている。

# 認証局 (CA) とは

「間違いなくこの公開鍵はこの人のものである」と証明できる人や組織のことである。

- 暗号技術入門:  P.256

# デジタル署名とは
改ざんと、なりすましを防ぐ技術である。

押印だけでは、間違いなく本人が捺印したかどうかはわからない。本人の押印であることを確かめるには、印鑑証明が必要である。デジタル署名は印鑑証明に相当する。

CAが公開鍵にデジタル署名をすることで、その公開鍵は確かに本人のものであると、CAが証明したことになる。CAは印鑑証明を発行する役所にあたる。

- 応用情報技術者: P609

# メッセージ認証コードとは
メッセージ認証コード (message authentication code: MAC) は、正真性を確認し、メッセージの認証を行う技術。

いくつか実現方法があるが、ハッシュ関数を使ったMACの実装をHMACと呼ぶ。

- ハッシュ関数にメッセージと共有鍵を元にしたパラメータを与え、MAC値を計算する。
- 改ざんの検出
    - メッセージが１ビットでも変更されると、MAC値が変化する。
- 認証
    - 共有鍵を持たない人は、MAC値を計算できない
    - 送信者から送られたMAC値が受信者が計算したMAC値と一致していれば認証成功

- 似ている？
    - メッセージ認証コードの鍵配送問題
    - 第三者に対する証明→デジタル署名が必要

### ハッシュ関数とは

# まとめ
